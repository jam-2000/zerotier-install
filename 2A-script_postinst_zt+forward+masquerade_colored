#!/bin/bash

# --- ANSI Color Definitions ---
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- 1. Root Check ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}!!! ERROR !!!${NC}"
   echo -e "${RED}This script must be run as root or with sudo.${NC}"
   exit 1
fi

# --- CONFIGURATION START ---
# Auto-detect public interface via default gateway
PUBLIC_INTERFACE=$(ip route | grep default | awk '{print $5}' | head -n 1)
# --- CONFIGURATION END ---

echo -e "${CYAN}--- Starting ZeroTier Router Cleanup & Setup ---${NC}"

# --- 2. Deduplication & Orphan Cleanup Function ---
cleanup_iptables() {
    echo -e "${YELLOW}Scanning for duplicate and orphaned rules...${NC}"
    
    local tables=("filter" "nat" "mangle")
    local active_zts=$(ip -o link show | awk -F': ' '/zt/{print $2}')

    for table in "${tables[@]}"; do
        # Extract rules and identify orphans or duplicates
        iptables-save -t "$table" | grep '^-A' | while read -r rule; do
            # Extract interface name if it contains 'zt'
            local iface=$(echo "$rule" | grep -oE 'zt[a-zA-Z0-9]+')
            
            # 1. Clean Orphans
            if [[ -n "$iface" ]] && ! echo "$active_zts" | grep -q "$iface"; then
                echo -e "  -> ${RED}Removing orphan rule from $table: $iface${NC}"
                iptables -t "$table" ${rule/-A/-D}
                continue
            fi

            # 2. Clean Duplicates
            local rule_args=${rule#*-A }
            local chain=${rule_args%% *}
            local params=${rule_args#* }
            # Match exactly (using -F for fixed string to handle special chars)
            local count=$(iptables -t "$table" -S "$chain" | grep -F -- "$params" | wc -l)

            if [ "$count" -gt 1 ]; then
                echo -e "  -> ${YELLOW}Found $count duplicates in $table/$chain. Deduplicating...${NC}"
                while [ "$count" -gt 1 ]; do
                    iptables -t "$table" -D "$chain" $params
                    count=$((count - 1))
                done
            fi
        done
    done
}

cleanup_iptables

# --- 3. Automatic Interface Detection ---
ZT_INTERFACE=$(ip -o link show | awk -F': ' '/zt/{print $2}' | head -n 1)

if [ -z "$ZT_INTERFACE" ]; then
    echo -e "${RED}Error: No active ZeroTier interface found.${NC}"
    exit 1
fi

echo -e "${GREEN}✅ Clean Active ZT Interface: ${ZT_INTERFACE}${NC}"
echo -e "${GREEN}✅ Public Interface: ${PUBLIC_INTERFACE}${NC}"

# --- 4. Helper Function: Add Rule if Missing ---
safe_add() {
    local table=$1
    local chain=$2
    shift 2
    if ! iptables -t "$table" -C "$chain" "$@" 2>/dev/null; then
        iptables -t "$table" -A "$chain" "$@"
        echo -e "  -> ${GREEN}Verified/Added rule to $table/$chain${NC}"
    else
        echo -e "  -> ${CYAN}Rule already unique in $table/$chain. No action.${NC}"
    fi
}

# --- 5. Enable IP Forwarding ---
echo -e "\n${CYAN}Step 1: Ensuring IP forwarding...${NC}"
echo "net.ipv4.ip_forward = 1" > /etc/sysctl.d/99-zerotier-router.conf
sysctl -p /etc/sysctl.d/99-zerotier-router.conf > /dev/null

# --- 6. Apply Rules Idempotently ---
echo -e "\n${CYAN}Step 2: Enforcing unique routing rules...${NC}"

# NAT Masquerade
safe_add nat POSTROUTING -o "$PUBLIC_INTERFACE" -j MASQUERADE

# Forwarding Rules
safe_add filter FORWARD -i "$ZT_INTERFACE" -o "$PUBLIC_INTERFACE" -j ACCEPT
safe_add filter FORWARD -i "$PUBLIC_INTERFACE" -o "$ZT_INTERFACE" -m state --state RELATED,ESTABLISHED -j ACCEPT

# MSS Clamping (MTU Fix)
safe_add mangle FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu

# --- 7. Save and Persist ---
echo -e "\n${CYAN}Step 3: Saving state...${NC}"
if command -v netfilter-persistent &> /dev/null; then
    netfilter-persistent save > /dev/null
    echo -e "${GREEN}✅ iptables-persistent updated.${NC}"
else
    # Fallback for systems without netfilter-persistent
    mkdir -p /etc/iptables
    iptables-save > /etc/iptables/rules.v4
    echo -e "${YELLOW}Note: Saved to /etc/iptables/rules.v4 (manual load might be required on reboot)${NC}"
fi

# --- 8. Final Summary ---
echo -e "\n${CYAN}--- Final Routing Summary ---${NC}"
echo -e "${WHITE}Active Forwarding Rules:${NC}"
iptables -L FORWARD -n -v --line-numbers
echo -e "\n${WHITE}Active NAT (Masquerade):${NC}"
iptables -t nat -L POSTROUTING -n -v --line-numbers

echo -e "\n${GREEN}--- Process Complete: All rules are now unique and verified ---${NC}"
