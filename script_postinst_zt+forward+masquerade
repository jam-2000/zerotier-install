#!/bin/bash

# FIRST STEPs:
# install zerotier-cli
# join ZeroTier Controller to its own ZeroTier Network 
# authorize it in its own ZeroTier Network

######################################################
# Now this ZeroTier Controller will be configured    #
# to act as the Gateway for its own ZeroTier Network #
######################################################

# --- CONFIGURATION START ---
# The public-facing (internet) interface, typically 'eth0' or 'enpXsY'
PUBLIC_INTERFACE="eth0"
# --- CONFIGURATION END ---

echo "--- Starting ZeroTier Router Setup Script ---"

# --- Automatic Interface Detection ---
# Find the active interface that starts with 'zt'
ZT_INTERFACE=$(ip -o link show | awk '/zt/{print $2}' | sed 's/://' | head -n 1)

if [ -z "$ZT_INTERFACE" ]; then
    echo ""
    echo "!!! ERROR !!!"
    echo "Could not find an active ZeroTier interface (starting with 'zt')."
    echo "Please ensure ZeroTier is running and connected."
    echo "Script aborted."
    exit 1
fi

echo "Auto-Detected ZeroTier Interface: ${ZT_INTERFACE}"
echo "Using Public Interface: ${PUBLIC_INTERFACE}"
echo "----------------------------------------------"

# 1. Enable IP Forwarding
echo "1. Enabling IP forwarding in /etc/sysctl.conf..."
LINE_TO_ADD="net.ipv4.ip_forward = 1"
if grep -qF "$LINE_TO_ADD" /etc/sysctl.conf; then
    echo "  -> net.ipv4.ip_forward is already set. Skipping addition."
else
    # Add the line to the file
    echo "$LINE_TO_ADD" | sudo tee -a /etc/sysctl.conf > /dev/null
    echo "  -> Line added."
fi

# Apply the sysctl change immediately
echo "  -> Applying sysctl changes..."
sudo sysctl -p

# 2. Install iptables-persistent
echo ""
echo "2. Installing iptables-persistent and netfilter-persistent..."
if ! command -v netfilter-persistent &> /dev/null
then
    sudo apt update
    sudo apt install -y iptables-persistent netfilter-persistent
    echo "  -> Installation complete."
else
    echo "  -> iptables-persistent is already installed. Skipping installation."
fi

# 3. Enable iptables MASQUERADE
echo ""
echo "3. Setting up iptables rules for NAT and forwarding..."

# Clear any previous MASQUERADE rules for this configuration (to allow rerunning safely)
echo "  -> Cleaning up any potential duplicate rules..."
sudo iptables -t nat -D POSTROUTING -o "${PUBLIC_INTERFACE}" -j MASQUERADE 2>/dev/null
sudo iptables -D FORWARD -i "${ZT_INTERFACE}" -o "${PUBLIC_INTERFACE}" -j ACCEPT 2>/dev/null
sudo iptables -D FORWARD -i "${PUBLIC_INTERFACE}" -o "${ZT_INTERFACE}" -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null

# Rule 1: MASQUERADE (NAT)
sudo iptables -t nat -A POSTROUTING -o "${PUBLIC_INTERFACE}" -j MASQUERADE
echo "  -> MASQUERADE rule added to NAT POSTROUTING."

# Rule 2: Forwarding (ZT to Public)
sudo iptables -A FORWARD -i "${ZT_INTERFACE}" -o "${PUBLIC_INTERFACE}" -j ACCEPT
echo "  -> FORWARD ACCEPT rule added (ZeroTier -> Public)."

# Rule 3: Forwarding (Public to ZT - ESTABLISHED/RELATED)
sudo iptables -A FORWARD -i "${PUBLIC_INTERFACE}" -o "${ZT_INTERFACE}" -m state --state RELATED,ESTABLISHED -j ACCEPT
echo "  -> FORWARD ACCEPT rule added (Public -> ZeroTier, for established connections)."

# 4. Save IPv4 and IPv6 rules
echo ""
echo "4. Saving iptables rules to make them persistent across reboots..."
sudo netfilter-persistent save
echo "  -> Rules saved successfully."

# 5. Show active iptables rules
echo ""
echo "5. Showing active iptables rules (FORWARD and NAT POSTROUTING):"
echo "--- FORWARD CHAIN ---"
sudo iptables -L FORWARD -v -n
echo ""
echo "--- NAT POSTROUTING CHAIN ---"
sudo iptables -t nat -L POSTROUTING -v -n

echo ""
echo "--- Script Complete ---"
