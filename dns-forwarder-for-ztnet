#!/bin/bash

# --- 1. Define Color Variables (ANSI Escape Codes) ---

# Standard Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'

# Formatting/Reset
BOLD='\033[1m'
NC='\033[0m' # No Color (Resets text color to default)

# --- Configuration Variables ---
# ZT_IP="10.11.12.1" Â  Â  Â  # REMOVED: Replaced by auto-discovery below
UPSTREAM_DNS="192.168.88.1" # The IP address to forward all DNS requests to
ZT_NETWORK_ID="<YOUR_ZEROTIER_NETWORK_ID>" # Replace with your ZeroTier Network ID
# -------------------------------

# ðŸ’¥ NEW SECTION: Auto-Discovery of ZeroTier IP ðŸ’¥

echo -e "${YELLOW}${BOLD}Detecting ZeroTier interface and IP address...${NC}"

# Find the ZeroTier interface name (e.g., zt_abcdefg)
ZT_INTERFACE=$(ip -o link show | awk '/zt/{print $2}' | sed 's/://' | head -n 1)

if [ -z "$ZT_INTERFACE" ]; then
    echo -e "${RED}!!! ERROR !!! Could not find an active ZeroTier interface (zt*).${NC}"
    echo -e "${RED}Please ensure ZeroTier is running and connected.${NC}"
    exit 1
fi

# Use zerotier-cli to find the IP assigned to the interface.
# 1. listnetworks output
# 2. grep for the interface name
# 3. awk to get the last field (IP addresses)
# 4. grep -oE to extract only the first IPv4 address
ZT_IP=$(sudo zerotier-cli listnetworks | \
        grep "${ZT_INTERFACE}" | \
        awk '{ print $NF }' | \
        grep -oE "([0-9]{1,3}\.){3}[0-9]{1,3}" | \
        head -n 1)

if [ -z "$ZT_IP" ]; then
    echo -e "${RED}!!! ERROR !!! Could not find an assigned IPv4 address for ${ZT_INTERFACE}.${NC}"
    echo -e "${RED}Ensure you are authorized in ZeroTier Central and connected.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Auto-Detected ZeroTier Interface: ${ZT_INTERFACE}${NC}"
echo -e "${GREEN}âœ… Auto-Detected ZeroTier IP (ZT_IP): ${ZT_IP}${NC}"
echo -e "---------------------------------------------------"

# ðŸ’¥ END NEW SECTION ðŸ’¥

echo -e "${CYAN}${BOLD}Starting Dnsmasq DNS Forwarder setup...${NC}"

# 2. Install Dnsmasq
echo -e "${BLUE}1. Installing dnsmasq...${NC}"
sudo apt update
# This is the line that required the auto-yes fix in the previous analysis
sudo DEBIAN_FRONTEND=noninteractive apt install -y dnsmasq

# 3. Disable systemd-resolved to free up port 53
echo -e "${BLUE}2. Disabling and stopping systemd-resolved to prevent port conflicts...${NC}"
if systemctl is-active --quiet systemd-resolved; then
    sudo systemctl disable --now systemd-resolved
    sudo rm -f /etc/resolv.conf
    echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf > /dev/null
    echo -e "${GREEN}Â  Â -> systemd-resolved successfully stopped and disabled.${NC}"
else
    echo -e "${YELLOW}Â  Â -> systemd-resolved does not appear to be running or is already disabled.${NC}"
fi

# 4. Configure Dnsmasq
echo -e "${BLUE}3. Configuring dnsmasq to listen on ZeroTier IP ($ZT_IP) and forward to $UPSTREAM_DNS...${NC}"

# Backup the original configuration file
sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.bak

# Create new configuration file
# NOTE: The $ZT_IP variable is now correctly populated and used here.
DNSMASQ_CONFIG="
# Listen only on the ZeroTier IP and the local loopback address
listen-address=127.0.0.1,$ZT_IP
# Specify the upstream DNS server
server=$UPSTREAM_DNS
# Do not use /etc/resolv.conf for upstream servers
no-resolv
# Only listen on specified interfaces/addresses
bind-interfaces
# Required to stop forwarding to other upstream servers configured elsewhere
no-hosts
"

# Write the new configuration
echo "$DNSMASQ_CONFIG" | sudo tee /etc/dnsmasq.d/zerotier-dns.conf > /dev/null
echo -e "${GREEN}Â  Â -> Dnsmasq configuration file written to /etc/dnsmasq.d/zerotier-dns.conf${NC}"

# 5. Restart Dnsmasq to apply changes
echo -e "${BLUE}4. Restarting dnsmasq service...${NC}"
sudo systemctl restart dnsmasq
sudo systemctl enable dnsmasq

# Display status with colors (Note: the status output itself will be standard text)
STATUS_OUTPUT=$(sudo systemctl status dnsmasq | grep "Active: ")
if echo "$STATUS_OUTPUT" | grep -q "active (running)"; then
    echo -e "${GREEN}${BOLD}Status: ${STATUS_OUTPUT}${NC}"
else
    echo -e "${RED}${BOLD}Status: ${STATUS_OUTPUT}${NC}"
fi

echo -e "${CYAN}${BOLD}--- Dnsmasq setup complete. ---${NC}"
echo -e "${YELLOW}The DNS forwarder is listening on ${BOLD}$ZT_IP${NC}${YELLOW} and forwarding to ${BOLD}$UPSTREAM_DNS${NC}"

# 6. ZeroTier Central Configuration Instructions
echo -e "\n${BOLD}--- NEXT STEPS: ZeroTier Central Configuration ---${NC}"
echo -e "${CYAN}You must now log into ZeroTier Central (my.zerotier.com) and configure your network.${NC}"
echo -e "* Go to your network settings."
echo -e "* Scroll to the ${BOLD}DNS${NC} section."
echo -e "* Set ${BOLD}Primary DNS Server${NC} to: ${GREEN}$ZT_IP${NC}"
echo -e "* ${BOLD}Save${NC} your changes."
echo -e "\n${BOLD}--- Client Configuration ---${NC}"
echo -e "On all client devices in the ZeroTier network, you can run:"
echo -e "${GREEN}sudo zerotier-cli set $ZT_NETWORK_ID allowDNS=1${NC}"
