#!/bin/bash
# Script to install and configure dnsmasq as a DNS forwarder
# It automatically finds the local ZeroTier IP for the 10.11.12.0/24 subnet.

# --- Configuration Variables ---
ZEROTIER_NETWORK_SUBNET="10.11.12.0/24"
UPSTREAM_DNS="192.168.88.1"
DNSMASQ_CONFIG="/etc/dnsmasq.d/zerotier_dns.conf"

echo "--- Starting Dynamic DNS Forwarder Setup ---"

# --- 1. Find the Local ZeroTier IP ---
echo "1. Attempting to find local ZeroTier IP for subnet: ${ZEROTIER_NETWORK_SUBNET}"

# Command to get the ZeroTier IP:
# 1. zerotier-cli listnetworks: Lists connected networks and managed IPs.
# 2. grep: Filters for the managed IP line corresponding to the target subnet (10.11.12.).
# 3. cut/awk: Extracts the IP address, excluding the subnet mask (/24).
ZEROTIER_IP=$(sudo zerotier-cli listnetworks | grep -oE "([0-9]{1,3}\.){3}[0-9]{1,3}/${ZEROTIER_NETWORK_SUBNET//\//}" | cut -d '/' -f 1 | head -n 1)

if [ -z "${ZEROTIER_IP}" ]; then
    echo "ERROR: Could not find the ZeroTier IP address in the ${ZEROTIER_NETWORK_SUBNET} subnet."
    echo "Please ensure ZeroTier is installed, running, and successfully connected/authorized on the network."
    exit 1
fi

echo "SUCCESS: Found local ZeroTier IP: ${ZEROTIER_IP}"
echo "------------------------------------------------------"

# --- 2. Install dnsmasq ---
echo "2. Updating package list and installing dnsmasq..."
sudo apt update
sudo apt install -y dnsmasq

# Check if installation was successful
if [ $? -ne 0 ]; then
    echo "ERROR: dnsmasq installation failed. Exiting."
    exit 1
fi

# --- 3. Configure dnsmasq ---
# Backup original config
if [ -f /etc/dnsmasq.conf ]; then
    echo "3. Backing up original dnsmasq.conf..."
    sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.bak
fi

# Create the dedicated ZeroTier DNS configuration file
echo "4. Creating dnsmasq configuration file: ${DNSMASQ_CONFIG}"
sudo bash -c "cat > ${DNSMASQ_CONFIG} << EOL
# ZeroTier DNS Forwarder Configuration
# Listen only on the dynamically found ZeroTier IP address
listen-address=${ZEROTIER_IP}

# Ensure that we do not poll /etc/resolv.conf for upstream DNS servers
no-resolv

# Specify the upstream DNS server to forward requests to
server=${UPSTREAM_DNS}

# Optional: You can specify the interface if needed (e.g., interface=zt+)
# interface=zt+
# except-interface=lo

port=53
EOL"

# --- 4. Restart and Verify ---
echo "5. Restarting dnsmasq service to apply changes..."
sudo systemctl restart dnsmasq

echo "6. Checking dnsmasq status..."
if sudo systemctl is-active --quiet dnsmasq; then
    echo "SUCCESS: dnsmasq is running and listening on ${ZEROTIER_IP}."
    echo "DNS requests will be forwarded to ${UPSTREAM_DNS}."
else
    echo "FAILURE: dnsmasq is not running. Check logs with 'sudo journalctl -xeu dnsmasq'."
fi

echo "--- DNS Forwarder Setup Complete ---"
echo "REMINDER: You must update your ZeroTier Controller (my.zerotier.com) DNS settings"
echo "to point to this IP: ${ZEROTIER_IP}"
