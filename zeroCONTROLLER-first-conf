#!/bin/bash

# ==========================================
# ZeroTier Controller Setup Script (No jq/python)
# For Ubuntu 22.04 LXC on Proxmox
# Update: Names host "zeroGW"
# ==========================================

# --- Colors for Friendly Output ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- 0. Preliminaries & Checks ---
clear

echo -e "${CYAN}-------------------------------------------------${NC}"
echo -e "${CYAN}   ZeroTier Controller Setup Assistant (LXC)     ${NC}"
echo -e "${CYAN}-------------------------------------------------${NC}"

if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}Please run as root.${NC}"
  exit 1
fi

if [ ! -e /dev/net/tun ]; then
    echo -e "${RED}Error: /dev/net/tun not found.${NC}"
    echo -e "${YELLOW}Please verify your LXC config includes:${NC}"
    echo "lxc.cgroup.devices.allow: c 10:200 rwm"
    echo "lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file 0 0"
    exit 1
fi

# Get Auth Token for API
AUTH_TOKEN=$(cat /var/lib/zerotier-one/authtoken.secret 2>/dev/null)
if [ -z "$AUTH_TOKEN" ]; then
    echo -e "${RED}Error: Could not read /var/lib/zerotier-one/authtoken.secret${NC}"
    exit 1
fi

API_URL="http://localhost:9993/controller"
MY_NODE_ID=$(zerotier-cli info | awk '{print $3}')
LAN_IP=$(ip -4 route get 1.1.1.1 | awk '{print $7; exit}')

echo -e "${GREEN}System Checks Passed.${NC}"
echo -e "Node ID: ${YELLOW}$MY_NODE_ID${NC}"
echo -e "LAN IP:  ${YELLOW}$LAN_IP${NC}"
echo ""

# ==========================================
# 1. Create Network
# ==========================================
echo -e "${BLUE}=== Step 1: Create Network ===${NC}"
read -p "Enter a name for the new network: " NET_NAME

if [ -z "$NET_NAME" ]; then NET_NAME="MyZeroTierNet"; fi

# Create network via API
RAW_RESP=$(curl -s -X POST -H "X-ZT1-Auth: $AUTH_TOKEN" -d "{\"name\": \"$NET_NAME\"}" "$API_URL/network")
ZT_NET_ID=$(echo "$RAW_RESP" | grep -o '"id":"[^"]*"' | head -n1 | cut -d'"' -f4)

if [ -z "$ZT_NET_ID" ] || [ ${#ZT_NET_ID} -ne 16 ]; then
    echo -e "${RED}Failed to create network. API Response:${NC}"
    echo "$RAW_RESP"
    exit 1
fi

echo -e "${GREEN}Network '$NET_NAME' created!${NC}"
echo -e "Network ID: ${YELLOW}$ZT_NET_ID${NC}"
echo ""

# ==========================================
# 2. Configure Subnet & Host
# ==========================================
echo -e "${BLUE}=== Step 2: Configure Subnet & Host ===${NC}"
echo -e "Enter the subnet using CIDR notation (e.g., 10.147.17.0/24)."
read -p "Subnet: " SUBNET_CIDR

# Validation
if [[ ! "$SUBNET_CIDR" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$ ]]; then
    echo -e "${RED}Invalid CIDR format. Exiting.${NC}"
    exit 1
fi

# Calculate IP ranges using awk
eval $(echo "$SUBNET_CIDR" | awk -F'[./]' '{
    mask=$5
    ip1=$1; ip2=$2; ip3=$3; ip4=$4
    
    printf "ZT_IP_CALC=\"%d.%d.%d.254\"\n", ip1, ip2, ip3
    printf "POOL_START=\"%d.%d.%d.1\"\n", ip1, ip2, ip3
    printf "POOL_END=\"%d.%d.%d.253\"\n", ip1, ip2, ip3
}')

ZT_IP="$ZT_IP_CALC"

echo -e "Configuring:"
echo -e "  Subnet:     $SUBNET_CIDR"
echo -e "  Host IP:    ${YELLOW}$ZT_IP${NC} (Name: zeroGW)"

# Construct JSON for Subnet config
CONFIG_JSON="{\"ipAssignmentPools\": [{\"ipRangeStart\": \"$POOL_START\", \"ipRangeEnd\": \"$POOL_END\"}], \"routes\": [{\"target\": \"$SUBNET_CIDR\", \"via\": null}], \"v4AssignMode\": \"zt\"}"

curl -s -X POST -H "X-ZT1-Auth: $AUTH_TOKEN" -d "$CONFIG_JSON" "$API_URL/network/$ZT_NET_ID" > /dev/null

# Join Host to Network
echo -e "Joining host to network..."
zerotier-cli join "$ZT_NET_ID"
sleep 2

# Authorize Self and Set Name
echo -e "Authorizing host and setting name to 'zeroGW'..."
# ADDED: "name": "zeroGW" to the JSON payload
MEMBER_JSON="{\"authorized\": true, \"ipAssignments\": [\"$ZT_IP\"], \"name\": \"zeroGW\"}"
curl -s -X POST -H "X-ZT1-Auth: $AUTH_TOKEN" -d "$MEMBER_JSON" "$API_URL/network/$ZT_NET_ID/member/$MY_NODE_ID" > /dev/null

echo -e "${GREEN}Host authorized with IP $ZT_IP${NC}"
echo ""

# ==========================================
# 3. Time Pause 1
# ==========================================
echo -e "${CYAN}-------------------------------------------------${NC}"
echo -e "Current Time: $(date)"
echo -e "${CYAN}-------------------------------------------------${NC}"
read -p "Press [Enter] to continue to Routes configuration..."
echo ""

# ==========================================
# 4. Managed Routes
# ==========================================
echo -e "${BLUE}=== Step 4: Managed Routes ===${NC}"

# Start with the default local subnet route
ROUTES_JSON="{\"target\": \"$SUBNET_CIDR\", \"via\": null}"

while true; do
    echo -e "${YELLOW}Would you like to add a managed route? (y/N)${NC}"
    read -r response
    if [[ ! "$response" =~ ^[yY] ]]; then
        break
    fi

    echo -e "Enter destination CIDR (e.g., 192.168.1.0/24 or 0.0.0.0/0):"
    read -p "Target: " ROUTE_TARGET

    echo -e "Gateway Option:"
    echo -e "  1) Physical LAN IP (${GREEN}$LAN_IP${NC}) [Default]"
    echo -e "  2) ZeroTier IP (${GREEN}$ZT_IP${NC})"
    echo -e "  3) Custom IP"
    read -p "Select Gateway (1-3): " GW_OPT

    case $GW_OPT in
        2) ROUTE_VIA="$ZT_IP" ;;
        3) read -p "Enter Gateway IP: " ROUTE_VIA ;;
        *) ROUTE_VIA="$LAN_IP" ;;
    esac

    # Add to JSON string
    ROUTES_JSON="$ROUTES_JSON, {\"target\": \"$ROUTE_TARGET\", \"via\": \"$ROUTE_VIA\"}"
    echo -e "${GREEN}Route added to queue: $ROUTE_TARGET via $ROUTE_VIA${NC}"
done

# Push updated routes
FULL_ROUTE_PAYLOAD="{\"routes\": [$ROUTES_JSON]}"
curl -s -X POST -H "X-ZT1-Auth: $AUTH_TOKEN" -d "$FULL_ROUTE_PAYLOAD" "$API_URL/network/$ZT_NET_ID" > /dev/null
echo -e "${GREEN}Routes configuration updated on controller.${NC}"
echo ""

# ==========================================
# 5. Time Pause 2
# ==========================================
echo -e "${CYAN}-------------------------------------------------${NC}"
echo -e "Current Time: $(date)"
echo -e "${CYAN}-------------------------------------------------${NC}"
read -p "Press [Enter] to continue to DNS configuration..."
echo ""

# ==========================================
# 6. DNS Configuration
# ==========================================
echo -e "${BLUE}=== Step 6: DNS Configuration ===${NC}"
echo -e "${YELLOW}Would you like to push a DNS server to clients? (y/N)${NC}"
read -r dns_response

if [[ "$dns_response" =~ ^[yY] ]]; then
    echo -e "Enter DNS Server IP (Default: ${GREEN}$ZT_IP${NC}):"
    read -p "DNS IP: " DNS_IP
    
    if [ -z "$DNS_IP" ]; then
        DNS_IP="$ZT_IP"
    fi

    echo -e "Enter Search Domain (optional, e.g., 'home.arpa'):"
    read -p "Domain: " DNS_DOMAIN

    # Construct DNS JSON
    DNS_PAYLOAD="{\"dns\": {\"domain\": \"$DNS_DOMAIN\", \"servers\": [\"$DNS_IP\"]}}"
    
    curl -s -X POST -H "X-ZT1-Auth: $AUTH_TOKEN" -d "$DNS_PAYLOAD" "$API_URL/network/$ZT_NET_ID" > /dev/null
    echo -e "${GREEN}DNS configuration updated: $DNS_IP ($DNS_DOMAIN)${NC}"
else
    echo "Skipping DNS configuration."
fi

# ==========================================
# Final Summary
# ==========================================
echo ""
echo -e "${CYAN}=================================================${NC}"
echo -e "${GREEN}   Setup Complete!   ${NC}"
echo -e "${CYAN}=================================================${NC}"
echo -e "Network Name: $NET_NAME"
echo -e "Network ID:   ${YELLOW}$ZT_NET_ID${NC}"
echo -e "Host Name:    ${YELLOW}zeroGW${NC}"
echo -e "Host IP:      $ZT_IP"
echo ""
echo -e "To view settings in ztncui, refresh your browser."
echo -e "To join other clients, run: zerotier-cli join $ZT_NET_ID"
echo ""
